# Multi-stage build for Python services (adapted for mock-service-now)
# Build args must be defined before first FROM
ARG SERVICE_NAME=mock-service-now
ARG MODULE_NAME=mock_servicenow.server
ARG BUILD_CONTEXT=.

# Builder stage
FROM registry.access.redhat.com/ubi9/python-312:latest as builder

USER root
RUN pip3 install --no-cache-dir uv

WORKDIR /app

# Copy service files
ARG SERVICE_NAME
COPY ${SERVICE_NAME}/pyproject.toml ${SERVICE_NAME}/uv.lock ./${SERVICE_NAME}/
COPY ${SERVICE_NAME}/src/ ./${SERVICE_NAME}/src/
COPY ${SERVICE_NAME}/README.md ./${SERVICE_NAME}/

# Copy mock-employee-data dependency
COPY mock-employee-data/ ./mock-employee-data/
COPY shared-models/ ./shared-models/

WORKDIR /app/${SERVICE_NAME}

# Install dependencies
RUN uv sync --frozen --no-cache --no-dev

# Production stage
FROM registry.access.redhat.com/ubi9/python-312-minimal:latest

WORKDIR /app

# Copy virtual environment from builder (service-specific)
ARG SERVICE_NAME
ENV OTEL_SERVICE_NAME=${SERVICE_NAME}
ENV OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED=true
COPY --from=builder /app/${SERVICE_NAME}/.venv /app/.venv

# Copy application source
ARG MODULE_NAME
COPY ${SERVICE_NAME}/src/ ./src/
COPY ${SERVICE_NAME}/pyproject.toml ./

# Set environment variables
ENV PATH="/app/.venv/bin:$PATH"
ENV PYTHONPATH="/app/src:$PYTHONPATH"
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Set the module name as an environment variable so it can be used in CMD
ENV MODULE_NAME=${MODULE_NAME}

# Drop privileges
USER 1001

# Expose port
EXPOSE 8080

# Add health check (like original Dockerfile)
# Note: curl is not available in minimal image, so we'll use python for health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD /app/.venv/bin/python -c "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')" || exit 1

# Run the application using absolute path to ensure virtualenv Python is used
# Support optional UVICORN_WORKERS environment variable for multi-process concurrency
CMD if [ -n "$UVICORN_WORKERS" ]; then \
      /app/.venv/bin/python -m uvicorn $MODULE_NAME:app --host 0.0.0.0 --port 8080 --workers $UVICORN_WORKERS; \
    else \
      /app/.venv/bin/python -m uvicorn $MODULE_NAME:app --host 0.0.0.0 --port 8080; \
    fi