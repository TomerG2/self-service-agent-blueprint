name: Pull Request - Integration + End to End Tests

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # Run daily at 2 AM UTC
  
jobs:
  e2e-tests:
    name: Run e2e tests
    runs-on: ubuntu-latest
    steps:
      - name: Validate LLM_API_TOKEN_EVAL secret
        shell: bash
        env:
          LLM_API_TOKEN: ${{ secrets.LLM_API_TOKEN_EVAL }}
        run: |
          if [ -z "${LLM_API_TOKEN}" ]; then
            echo "LLM_API_TOKEN_EVAL secret is missing or empty. Set it in repository or organization secrets."
            exit 1
          fi
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v6
        with:
          version: "0.6.17"
          python-version: "3.12"

      - name: Install Local Dependencies
        shell: bash
        run: |
          make oc
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH

      - name: Initialize cluster and deploy application
        uses: ./.github/actions/kind
        with:
          llm: ${{ vars.LLM_INFERENCE }}
          llm_id: ${{ vars.LLM_ID_INFERENCE }}
          llm_url: ${{ vars.LLM_URL_INFERENCE }}
        env:
          LLM_API_TOKEN: ${{ secrets.LLM_API_TOKEN_INFERENCE }}
          SERVICENOW_INSTANCE_URL: http://self-service-agent-mock-servicenow:8080
          SERVICENOW_LAPTOP_REFRESH_ID: mock_laptop_refresh_id
          SERVICENOW_API_KEY: mock_api_key

      - name: Set `test` as default namespace on Kind
        shell: bash
        run: |
          kubectl config set-context --current --namespace=test

      - name: Verify mock ServiceNow service is ready
        shell: bash
        run: |
          echo "Waiting for mock ServiceNow service to be ready..."

          # Get the service name dynamically
          SERVICE_NAME=$(kubectl get services -l app.kubernetes.io/component=mock-servicenow -o jsonpath='{.items[0].metadata.name}')
          if [ -z "$SERVICE_NAME" ]; then
            echo "❌ Mock ServiceNow service not found"
            kubectl get services -l app.kubernetes.io/component=mock-servicenow
            exit 1
          fi
          echo "Found mock ServiceNow service: $SERVICE_NAME"

          # Wait for the service endpoint to be ready
          for i in {1..30}; do
            if kubectl run --rm -i --restart=Never test-servicenow-$$ --image=curlimages/curl:latest --timeout=10s -- \
               curl -f http://$SERVICE_NAME:8080/health; then
              echo "✅ Mock ServiceNow service is healthy"
              break
            else
              echo "⏳ Attempt $i/30: Mock ServiceNow service not ready yet, waiting 10s..."
              if [ $i -eq 30 ]; then
                echo "❌ Mock ServiceNow service failed to become ready after 5 minutes"
                echo "Service status:"
                kubectl get service $SERVICE_NAME
                echo "Pod status:"
                kubectl get pods -l app.kubernetes.io/component=mock-servicenow
                echo "Pod logs:"
                kubectl logs -l app.kubernetes.io/component=mock-servicenow --tail=50
                exit 1
              fi
              sleep 10
            fi
          done

      - name: Verify MCP server can connect to mock ServiceNow
        shell: bash
        run: |
          echo "Testing MCP server connection to mock ServiceNow..."

          # Get the MCP server pod
          MCP_POD=$(kubectl get pods -l app.kubernetes.io/name=self-service-agent-snow -o jsonpath='{.items[0].metadata.name}')
          if [ -z "$MCP_POD" ]; then
            echo "❌ MCP server pod not found"
            kubectl get pods -l app.kubernetes.io/name=self-service-agent-snow
            exit 1
          fi
          echo "Found MCP server pod: $MCP_POD"

          # Test ServiceNow connectivity from within the MCP pod
          echo "Testing connectivity to mock ServiceNow from MCP server pod..."
          kubectl exec $MCP_POD -- curl -f -m 10 http://self-service-agent-mock-servicenow:8080/health || {
            echo "❌ MCP server cannot connect to mock ServiceNow service"
            echo "MCP Pod logs:"
            kubectl logs $MCP_POD --tail=50
            echo "Mock ServiceNow pod logs:"
            kubectl logs -l app.kubernetes.io/component=mock-servicenow --tail=50
            exit 1
          }
          echo "✅ MCP server can successfully connect to mock ServiceNow service"

      - name: Install evaluations dependencies
        shell: bash
        run: |
          make sync-evaluations

      - name: Run responses evaluations (Request Manager)
        if: always()
        shell: bash
        run: |
          make test-short-resp-integration-request-mgr
        env:
          LLM_URL: ${{ vars.LLM_URL_EVAL }}
          LLM_API_TOKEN: ${{ secrets.LLM_API_TOKEN_EVAL }}

      - name: Inspect Cluster - Self-Service Agent
        if: failure()
        uses: ./.github/actions/inspect
        with:
          artifactPrefix: self-service-agent

      - name: Create evaluations tarball
        if: always()
        shell: bash
        run: |
          if [ -d "evaluations/results" ]; then
            tar -czf evaluations-results-${{ github.run_id }}.tar.gz -C evaluations results/
            echo "Tarball created successfully from evaluations/results/"
            ls -lh evaluations-results-${{ github.run_id }}.tar.gz
          else
            echo "evaluations/results directory not found, creating empty marker"
            mkdir -p evaluations/results
            echo "No evaluation results were generated" > evaluations/results/README.txt
            tar -czf evaluations-results-${{ github.run_id }}.tar.gz -C evaluations results/
          fi

      - name: Upload evaluations artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evaluations-results-${{ github.run_id }}
          path: evaluations-results-${{ github.run_id }}.tar.gz
          retention-days: 30
          if-no-files-found: warn
